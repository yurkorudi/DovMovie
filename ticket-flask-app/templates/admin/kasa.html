<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin-styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/kasa.css') }}">
    <title>Робоча каса</title>
</head>
<body>
     {% include 'admin/admin-header.html' %}

     <main>
        <div class="kasa-holl">
            <section class="hall-wrapper">
                <div class="hall">
                <div class="screen">Екран</div>
                <div id="price-display" class="price-display"></div>
                <div id="seats"></div>
                </div>
            </section>
        </div>
        <div class="kasa-menu">
            <div class="kasa-shedule">
                <input type="date" id="myDate" name="myDate">
            </div>
            <div class="kasa-session">
                <div id="sessionList"></div>
            </div>
            <div class="kasa-action">
                <form action="" method="post">
                    <button type="submit">cash</button>
                </form>
                <form action="" method="post">
                    <button type="submit">card</button>
                </form>
                <form action="" method="post">
                    <button type="submit">return</button>
                </form>
            </div>
        </div>
     </main>

<script>
window.addEventListener('DOMContentLoaded', () => {
  // ==== Параметри залу ====
  const hallStructure = [
    [1,1,1,1,1,1,1,0,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,0,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,0,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,0,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,0,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,0,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,0,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,0,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,0,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,0,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,0,1,1,1,1,1,1],
    [1,1,1,1,3,2,1,0,1,1,1,1,1,1],
  ];
  const occupiedBySession = {{ occupied_seats|default([])|tojson }};
  const priceMap = {
    1: {{ session.price|default(100, true) }},
    2: 150,
    3: 200
  };

  const seatsEl      = document.getElementById('seats');
  const priceDisplay = document.getElementById('price-display');

  function drawHall() {
    seatsEl.innerHTML = '';
    priceDisplay.textContent = '';

    const seatSize = 32,
          gapSize  = 2,
          cols     = Math.max(...hallStructure.map(r=>r.length));

    seatsEl.style.display             = 'inline-grid';
    seatsEl.style.gridAutoRows        = `${seatSize}px`;
    seatsEl.style.gap                 = `${gapSize}px`;
    seatsEl.style.gridTemplateColumns = `repeat(${cols}, ${seatSize}px)`;

    hallStructure.forEach((rowArr, r) => {
      rowArr.forEach((cell, c) => {
        if (cell === 0) {
          const gap = document.createElement('div');
          gap.className = 'seat-gap';
          seatsEl.appendChild(gap);
          return;
        }
        const div = document.createElement('div');
        div.className   = `place type-${cell}`;
        div.dataset.row = r;
        div.dataset.col = c;
        div.dataset.price = priceMap[cell];

        const isOcc = occupiedBySession.some(o =>
          o.row === r && o.seatNumber === c
        );
        if (isOcc) {
          div.classList.add('occupied');
        } else {
          div.addEventListener('mouseover', () => {
            priceDisplay.textContent = `${div.dataset.price} ₴`;
          });
          div.addEventListener('mouseout', () => {
            priceDisplay.textContent = '';
          });
          div.addEventListener('click', () => {
            div.classList.toggle('selected');
            updateSelectedSeats();
          });
        }
        seatsEl.appendChild(div);
      });
    });
  }

  function updateSelectedSeats() {
    const selected = Array.from(seatsEl.querySelectorAll('.place.selected'));
    const arr = selected.map(el => ({
      row: +el.dataset.row,
      seatNumber: +el.dataset.col,
      cost: +el.dataset.price
    }));
    // ваш подальший код для обробки вибраних місць…
    console.log('Вибрані місця:', arr);
  }

  // Перше малювання залу
  drawHall();

  // ==== Робота з календарем і сесіями ====
  const dateInput   = document.getElementById('myDate');
  const sessionList = document.getElementById('sessionList');

  if (!dateInput || !sessionList) {
    console.error('Не знайдено #myDate або #sessionList – перевір HTML');
    return;
  }

  async function fetchSessions(date) {
    console.log('Запит сесій на дату:', date);
    try {
      const res = await fetch(`/api/sessions?date=${date}`);
      console.log('Статус відповіді:', res.status);
      const data = await res.json();
      console.log('Отримані сесії:', data);
      renderSessions(data);
    } catch (err) {
      console.error('Помилка fetchSessions:', err);
    }
  }

  function renderSessions(sessions) {
    sessionList.innerHTML = '';
    if (!sessions.length) {
      sessionList.textContent = 'Немає сеансів на цей день';
      return;
    }
    sessions.forEach(s => {
      const div = document.createElement('div');
      div.className = 'session-item';
      div.innerHTML = `
        <strong>${s.time}</strong>
        <span>${s.title}</span>
        <em>(${s.duration} хв)</em>
      `;
      div.addEventListener('click', () => {
        console.log(`Сеанс ${s.id} обрано`);
        // тут можна оновити occupiedBySession і викликати drawHall()
      });
      sessionList.appendChild(div);
    });
  }

  dateInput.addEventListener('change', () => {
    fetchSessions(dateInput.value);
  });

  // Встановити сьогодні і завантажити сесії
  const today = new Date().toISOString().split('T')[0];
  dateInput.value = today;
  fetchSessions(today);
});
</script>

</body>
</html>